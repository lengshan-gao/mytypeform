# æƒé‡é—®å·ç³»ç»Ÿ - è…¾è®¯äº‘éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æƒé‡é—®å·ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº Next.js 12.3.4 çš„å…¨æ ˆåº”ç”¨ï¼Œæ”¯æŒæƒé‡è®¡ç®—é—®å·çš„åˆ›å»ºã€å›ç­”å’Œæ•°æ®åˆ†æã€‚ç³»ç»ŸåŒ…å«å›¾ç‰‡ä¸Šä¼ ã€æ”¾å¤§æŸ¥çœ‹ã€å¤šé¡¹ç›®å¯¹æ¯”ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸš€ éƒ¨ç½²æ¶æ„

### æ¨èæ¶æ„æ–¹æ¡ˆ
- **Web æœåŠ¡**: è…¾è®¯äº‘ CVMï¼ˆäº‘æœåŠ¡å™¨ï¼‰æˆ– SCFï¼ˆäº‘å‡½æ•°ï¼‰
- **æ•°æ®åº“**: è…¾è®¯äº‘ TDSQL-Cï¼ˆäº‘åŸç”Ÿæ•°æ®åº“ï¼‰
- **æ–‡ä»¶å­˜å‚¨**: è…¾è®¯äº‘ COSï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰
- **CDN åŠ é€Ÿ**: è…¾è®¯äº‘ CDN
- **åŸŸå**: è…¾è®¯äº‘ DNSPod

### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: Next.js 12.3.4 + TypeScript
- **åç«¯**: Node.js API Routes
- **æ•°æ®åº“**: PostgreSQLï¼ˆPrisma ORMï¼‰
- **æ–‡ä»¶ä¸Šä¼ **: Base64 ç¼–ç å­˜å‚¨
- **éƒ¨ç½²**: äº‘æœåŠ¡å™¨æˆ–äº‘å‡½æ•°

## ğŸ“¦ éƒ¨ç½²å‰å‡†å¤‡

### 1. è…¾è®¯äº‘è´¦æˆ·å‡†å¤‡
- æ³¨å†Œè…¾è®¯äº‘è´¦æˆ·å¹¶å®Œæˆå®åè®¤è¯
- å¼€é€šä»¥ä¸‹æœåŠ¡ï¼š
  - CVMï¼ˆäº‘æœåŠ¡å™¨ï¼‰æˆ– SCFï¼ˆäº‘å‡½æ•°ï¼‰
  - TDSQL-Cï¼ˆäº‘åŸç”Ÿæ•°æ®åº“ï¼‰
  - COSï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰
  - CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰

### 2. é¡¹ç›®æ–‡ä»¶æ£€æŸ¥
ç¡®ä¿é¡¹ç›®åŒ…å«ä»¥ä¸‹å…³é”®æ–‡ä»¶ï¼š
- `package.json` - ä¾èµ–ç®¡ç†
- `next.config.js` - Next.js é…ç½®
- `prisma/schema.prisma` - æ•°æ®åº“æ¨¡å‹
- `pages/` - é¡µé¢å’Œ API è·¯ç”±
- `.env.example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹

### 3. ç¯å¢ƒå˜é‡é…ç½®
åˆ›å»º `.env.production` æ–‡ä»¶ï¼š
```env
# æ•°æ®åº“é…ç½®
DATABASE_URL="postgresql://username:password@tdsql-c-host:5432/survey_system"

# åº”ç”¨é…ç½®
NEXTAUTH_SECRET="your-production-secret-key"
NEXTAUTH_URL="https://your-domain.com"

# è…¾è®¯äº‘ COS é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒæ–‡ä»¶å­˜å‚¨ï¼‰
COS_SECRET_ID="your-cos-secret-id"
COS_SECRET_KEY="your-cos-secret-key"
COS_REGION="ap-guangzhou"
COS_BUCKET="your-bucket-name"

# å…¶ä»–é…ç½®
NODE_ENV="production"
```

## ğŸ› ï¸ éƒ¨ç½²æ–¹æ¡ˆä¸€ï¼šäº‘æœåŠ¡å™¨ï¼ˆCVMï¼‰éƒ¨ç½²

### æ­¥éª¤ 1ï¼šåˆ›å»ºäº‘æœåŠ¡å™¨
1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥ CVM äº§å“é¡µé¢
3. åˆ›å»ºäº‘æœåŠ¡å™¨å®ä¾‹ï¼š
   - **åœ°åŸŸ**: é€‰æ‹©ç¦»ç”¨æˆ·æœ€è¿‘çš„åœ°åŸŸ
   - **å®ä¾‹ç±»å‹**: å»ºè®® 2æ ¸4G æˆ–æ›´é«˜é…ç½®
   - **é•œåƒ**: Ubuntu 20.04 LTS æˆ– CentOS 8
   - **ç³»ç»Ÿç›˜**: 50GB SSD äº‘ç¡¬ç›˜
   - **å®‰å…¨ç»„**: å¼€æ”¾ 22(SSH)ã€80(HTTP)ã€443(HTTPS) ç«¯å£

### æ­¥éª¤ 2ï¼šæœåŠ¡å™¨ç¯å¢ƒé…ç½®
```bash
# æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update && sudo apt upgrade -y

# å®‰è£… Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£… PM2 è¿›ç¨‹ç®¡ç†
sudo npm install -g pm2

# å®‰è£… Nginx
sudo apt install nginx -y

# å®‰è£… PostgreSQL å®¢æˆ·ç«¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo apt install postgresql-client -y
```

### æ­¥éª¤ 3ï¼šéƒ¨ç½²åº”ç”¨
```bash
# å…‹éš†ä»£ç åˆ°æœåŠ¡å™¨
git clone https://github.com/lengshan-gao/mytypeform.git
cd mytypeform

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºåº”ç”¨
npm run build

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env.production
# ç¼–è¾‘ .env.production æ–‡ä»¶ï¼Œå¡«å…¥å®é™…é…ç½®

# æ•°æ®åº“è¿ç§»
npx prisma generate
npx prisma db push

# ä½¿ç”¨ PM2 å¯åŠ¨åº”ç”¨
pm2 start npm --name "survey-system" -- start
pm2 save
pm2 startup
```

### æ­¥éª¤ 4ï¼šé…ç½® Nginx åå‘ä»£ç†
åˆ›å»º `/etc/nginx/sites-available/survey-system`ï¼š
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # é™æ€æ–‡ä»¶ç¼“å­˜
    location /_next/static/ {
        proxy_cache_valid 200 302 1y;
        proxy_pass http://localhost:3000;
    }
}
```

å¯ç”¨ç«™ç‚¹ï¼š
```bash
sudo ln -s /etc/nginx/sites-available/survey-system /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## ğŸ› ï¸ éƒ¨ç½²æ–¹æ¡ˆäºŒï¼šäº‘å‡½æ•°ï¼ˆSCFï¼‰éƒ¨ç½²

### æ­¥éª¤ 1ï¼šåˆ›å»ºäº‘å‡½æ•°
1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥äº‘å‡½æ•° SCF äº§å“é¡µé¢
3. åˆ›å»ºæ–°å‡½æ•°ï¼š
   - **å‡½æ•°ç±»å‹**: Web å‡½æ•°
   - **è¿è¡Œç¯å¢ƒ**: Node.js 16.13
   - **éƒ¨ç½²æ–¹å¼**: ä»£ç éƒ¨ç½²

### æ­¥éª¤ 2ï¼šå‡†å¤‡éƒ¨ç½²åŒ…
åˆ›å»º `scf_bootstrap` å¯åŠ¨è„šæœ¬ï¼š
```bash
#!/bin/bash
./node_modules/.bin/next start
```

åˆ›å»ºéƒ¨ç½²é…ç½®æ–‡ä»¶ `serverless.yml`ï¼š
```yaml
component: scf
name: survey-system
inputs:
  name: survey-system
  src: .
  region: ap-guangzhou
  runtime: Nodejs16.13
  type: web
  memorySize: 512
  timeout: 30
  environment:
    variables:
      NODE_ENV: production
  events:
    - apigw:
        parameters:
          protocols:
            - http
            - https
          environment: release
          endpoints:
            - path: /
              method: ANY
            - path: /{path}
              method: ANY
```

### æ­¥éª¤ 3ï¼šéƒ¨ç½²åˆ°äº‘å‡½æ•°
```bash
# å®‰è£… Serverless Framework
npm install -g serverless

# é…ç½®è…¾è®¯äº‘å‡­è¯
serverless credentials set --provider tencent --secret-id YOUR_SECRET_ID --secret-key YOUR_SECRET_KEY

# éƒ¨ç½²
serverless deploy
```

## ğŸ—„ï¸ æ•°æ®åº“éƒ¨ç½²ï¼ˆTDSQL-Cï¼‰

### æ­¥éª¤ 1ï¼šåˆ›å»ºæ•°æ®åº“å®ä¾‹
1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥ TDSQL-C äº§å“é¡µé¢
3. åˆ›å»º PostgreSQL å®ä¾‹ï¼š
   - **åœ°åŸŸ**: ä¸æœåŠ¡å™¨ç›¸åŒåœ°åŸŸ
   - **è§„æ ¼**: 1æ ¸2G èµ·æ­¥
   - **å­˜å‚¨**: 50GB SSD
   - **ç½‘ç»œ**: ç§æœ‰ç½‘ç»œ VPC

### æ­¥éª¤ 2ï¼šæ•°æ®åº“é…ç½®
```bash
# è¿æ¥æ•°æ®åº“
psql -h your-db-host -U username -d survey_system

# æ‰§è¡Œ Prisma è¿ç§»
npx prisma migrate deploy

# å¯é€‰ï¼šå¯¼å…¥åˆå§‹æ•°æ®
npx prisma db seed
```

## ğŸ“ æ–‡ä»¶å­˜å‚¨é…ç½®ï¼ˆCOSï¼‰

### æ­¥éª¤ 1ï¼šåˆ›å»ºå­˜å‚¨æ¡¶
1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥ COS äº§å“é¡µé¢
3. åˆ›å»ºå­˜å‚¨æ¡¶ï¼š
   - **åœ°åŸŸ**: é€‰æ‹©åˆé€‚çš„åœ°åŸŸ
   - **æƒé™**: å…¬æœ‰è¯»ç§æœ‰å†™
   - **ç‰ˆæœ¬æ§åˆ¶**: å¼€å¯ï¼ˆå¯é€‰ï¼‰

### æ­¥éª¤ 2ï¼šé›†æˆ COS SDK
ä¿®æ”¹å›¾ç‰‡ä¸Šä¼  APIï¼Œæ”¯æŒ COS å­˜å‚¨ï¼š
```typescript
// pages/api/upload-cos.ts
import COS from 'cos-nodejs-sdk-v5';

const cos = new COS({
  SecretId: process.env.COS_SECRET_ID,
  SecretKey: process.env.COS_SECRET_KEY,
});
```

## ğŸŒ åŸŸåå’Œ SSL é…ç½®

### æ­¥éª¤ 1ï¼šåŸŸåè§£æ
1. åœ¨ DNSPod æ·»åŠ åŸŸåè§£æ
2. å°†åŸŸå A è®°å½•æŒ‡å‘æœåŠ¡å™¨ IP æˆ–äº‘å‡½æ•°åŸŸå

### æ­¥éª¤ 2ï¼šSSL è¯ä¹¦
1. ç”³è¯·å…è´¹ SSL è¯ä¹¦ï¼ˆTrustAsia æˆ– Let's Encryptï¼‰
2. åœ¨ Nginx æˆ–äº‘å‡½æ•°ä¸­é…ç½® HTTPS

## ğŸ”§ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

### 1. æ€§èƒ½ä¼˜åŒ–
```javascript
// next.config.js ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
  compress: true,
  poweredByHeader: false,
  
  // å›¾ç‰‡ä¼˜åŒ–
  images: {
    domains: ['your-cos-domain.cos.ap-guangzhou.myqcloud.com'],
    formats: ['image/avif', 'image/webp'],
  },
  
  // å®‰å…¨å¤´è®¾ç½®
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
        ],
      },
    ];
  },
};
```

### 2. ç›‘æ§å’Œæ—¥å¿—
```bash
# å®‰è£…ç›‘æ§å·¥å…·
npm install --save @tencentcloud/tencentcloud-monitor

# é…ç½®æ—¥å¿—
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30
```

### 3. å¤‡ä»½ç­–ç•¥
- **æ•°æ®åº“**: è‡ªåŠ¨å¤‡ä»½ï¼ˆTDSQL-C æ”¯æŒï¼‰
- **ä»£ç **: GitHub ä»“åº“å¤‡ä»½
- **æ–‡ä»¶**: COS ç‰ˆæœ¬æ§åˆ¶

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
psql -h your-db-host -U username -d survey_system

# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $DATABASE_URL
```

#### 2. åº”ç”¨å¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep :3000

# æŸ¥çœ‹ PM2 æ—¥å¿—
pm2 logs survey-system
```

#### 3. é™æ€èµ„æºåŠ è½½å¤±è´¥
```nginx
# Nginx é…ç½®æ£€æŸ¥
location /_next/static/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### æ€§èƒ½ç›‘æ§
- **æœåŠ¡å™¨ç›‘æ§**: äº‘ç›‘æ§æ§åˆ¶å°
- **åº”ç”¨ç›‘æ§**: PM2 ç›‘æ§é¢æ¿
- **æ•°æ®åº“ç›‘æ§**: TDSQL-C ç›‘æ§
- **CDN ç›‘æ§**: è…¾è®¯äº‘ CDN æ§åˆ¶å°

## ğŸ“Š æˆæœ¬ä¼°ç®—

### åŸºç¡€é…ç½®ï¼ˆæœˆè´¹ç”¨ï¼‰
- **CVM äº‘æœåŠ¡å™¨**: çº¦ 100-200 å…ƒ/æœˆ
- **TDSQL-C æ•°æ®åº“**: çº¦ 50-100 å…ƒ/æœˆ
- **COS å­˜å‚¨**: æŒ‰ä½¿ç”¨é‡è®¡è´¹ï¼ˆçº¦ 10-30 å…ƒ/æœˆï¼‰
- **CDN åŠ é€Ÿ**: æŒ‰æµé‡è®¡è´¹ï¼ˆçº¦ 20-50 å…ƒ/æœˆï¼‰

### ä¼˜åŒ–å»ºè®®
- æ ¹æ®è®¿é—®é‡é€‰æ‹©åˆé€‚çš„é…ç½®
- ä½¿ç”¨å¯¹è±¡å­˜å‚¨ CDN é™ä½å¸¦å®½æˆæœ¬
- è®¾ç½®è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥åº”å¯¹æµé‡é«˜å³°

## ğŸ”„ æŒç»­éƒ¨ç½²

### GitHub Actions è‡ªåŠ¨åŒ–
åˆ›å»º `.github/workflows/deploy.yml`ï¼š
```yaml
name: Deploy to Tencent Cloud

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Build application
      run: npm run build
      
    - name: Deploy to CVM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /path/to/your/app
          git pull origin master
          npm install
          npm run build
          pm2 restart survey-system
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å®˜æ–¹æ–‡æ¡£
- [è…¾è®¯äº‘ CVM æ–‡æ¡£](https://cloud.tencent.com/document/product/213)
- [è…¾è®¯äº‘ SCF æ–‡æ¡£](https://cloud.tencent.com/document/product/583)
- [è…¾è®¯äº‘ TDSQL-C æ–‡æ¡£](https://cloud.tencent.com/document/product/1003)
- [Next.js éƒ¨ç½²æ–‡æ¡£](https://nextjs.org/docs/deployment)

### é—®é¢˜åé¦ˆ
å¦‚é‡éƒ¨ç½²é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. é”™è¯¯æ—¥å¿—å†…å®¹
2. éƒ¨ç½²ç¯å¢ƒä¿¡æ¯
3. ç›¸å…³é…ç½®æˆªå›¾

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-27  
**é€‚ç”¨ç‰ˆæœ¬**: Next.js 12.3.4 + TypeScript  
**éƒ¨ç½²ç¯å¢ƒ**: è…¾è®¯äº‘å…¨æ ˆæœåŠ¡