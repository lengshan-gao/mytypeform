# 调查问卷系统开发设计方案

## 1. 项目概述

### 1.1 项目背景
本项目是一个类似问卷星的在线调查问卷平台，支持用户创建、分发、填写和统计调查问卷，重点支持微信扫码填写和问题图片上传功能。

### 1.2 核心功能
- 问卷创建与管理
- 支持问题图片上传
- 分数权重设置
- 二维码分发
- 微信扫码填写
- 数据统计与可视化

### 1.3 目标用户
- 企业管理人员
- 市场调研人员
- 教育工作者
- 需要收集反馈的个人用户

## 2. 技术架构设计

### 2.1 技术栈选型

#### 2.1.1 前端技术栈
| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| React | 18.x | 前端框架 | 组件化开发，生态成熟，支持Serverless部署 |
| Next.js | 14.x | 全栈框架 | 支持SSR/SSG，适合Vercel部署，路由管理便捷 |
| Tailwind CSS | 3.x | 样式框架 | 快速开发，响应式设计，适合微信适配 |
| Chart.js | 4.x | 图表库 | 轻量，支持柱状图等多种图表，文档丰富 |
| Axios | 1.x | HTTP客户端 | 异步请求处理，支持拦截器 |
| QRCode.js | - | 二维码生成 | 轻量，支持自定义样式，适合前端生成 |
| WeChat JS-SDK | - | 微信集成 | 官方SDK，支持微信环境功能 |

#### 2.1.2 后端技术栈
| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| Node.js | 14.x | 运行环境 | 前后端同构，适合Vercel部署 |
| Next.js API Routes | 14.x | API开发 | 内置API路由，无需额外服务器，适合Serverless |
| Prisma | 5.x | ORM框架 | 类型安全，支持多种数据库，迁移便捷 |
| JWT | - | 认证授权 | 无状态认证，适合Serverless架构 |

#### 2.1.3 数据库
| 数据库 | 类型 | 用途 | 选型理由 |
|--------|------|------|----------|
| PostgreSQL | 关系型 | 主要数据存储 | 支持复杂查询，事务处理，适合统计分析 |
| Supabase | 云数据库 | 数据库服务 | 开源，与Next.js兼容性好，适合Vercel部署 |

#### 2.1.4 存储服务
| 服务 | 用途 | 选型理由 |
|------|------|----------|
| Cloudinary | 图片存储 | 支持图片上传、处理和CDN加速，API友好 |
| 腾讯云COS | 图片存储 | 国内访问速度快，适合腾讯云部署 |

### 2.2 系统架构设计

#### 2.2.1 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                       客户端层                           │
├─────────────────┬─────────────────┬─────────────────────┤
│ 微信浏览器      │ 桌面浏览器      │ 移动浏览器          │
└─────────────────┴─────────────────┴─────────────────────┘
                        │ HTTPS
┌─────────────────────────────────────────────────────────┐
│                       接入层                             │
├─────────────────┬─────────────────┬─────────────────────┤
│ CDN加速         │ SSL证书         │ WAF防护             │
└─────────────────┴─────────────────┴─────────────────────┘
                        │
┌─────────────────────────────────────────────────────────┐
│                       应用层                             │
├─────────────────┬─────────────────┬─────────────────────┤
│ 前端应用        │ API服务         │ 微信集成服务        │
│ (Next.js)       │ (Next.js API)   │ (WeChat JS-SDK)     │
└─────────────────┴─────────────────┴─────────────────────┘
                        │
┌─────────────────────────────────────────────────────────┐
│                       数据层                             │
├─────────────────┬─────────────────┬─────────────────────┤
│ 数据库          │ 存储服务        │ 缓存服务(可选)      │
│ (PostgreSQL)    │ (Cloudinary)    │ (Redis)             │
└─────────────────┴─────────────────┴─────────────────────┘
```

#### 2.2.2 模块架构
```
┌─────────────────────────────────────────────────────────┐
│                     问卷管理模块                         │
├─────────┬─────────┬─────────┬─────────┬─────────┬───────┤
│ 创建    │ 编辑    │ 删除    │ 预览    │ 复制    │ 状态  │
│ 问卷    │ 问卷    │ 问卷    │ 问卷    │ 问卷    │ 管理  │
└─────────┴─────────┴─────────┴─────────┴─────────┴───────┘
                        │
┌─────────────────────────────────────────────────────────┐
│                     问题管理模块                         │
├─────────┬─────────┬─────────┬─────────┬─────────┬───────┤
│ 添加    │ 编辑    │ 删除    │ 设置    │ 上传    │ 排序  │
│ 问题    │ 问题    │ 问题    │ 权重    │ 图片    │ 问题  │
└─────────┴─────────┴─────────┴─────────┴─────────┴───────┘
                        │
┌─────────────────────────────────────────────────────────┐
│                     分发管理模块                         │
├─────────┬─────────┬─────────────────┬─────────────────┤
│ 生成    │ 生成    │ 分享              │
│ 链接    │ 二维码  │ 问卷            │                 │
└─────────┴─────────┴─────────────────┴─────────────────┘
                        │
┌─────────────────────────────────────────────────────────┐
│                     填写模块                             │
├─────────┬─────────┬─────────┬─────────┬─────────────────┤
│ 加载    │ 显示    │ 填写    │ 验证    │ 提交            │
│ 问卷    │ 问题    │ 单选/多选    │ 答案    │ 答案            │
└─────────┴─────────┴─────────┴─────────┴─────────────────┘
                        │
┌─────────────────────────────────────────────────────────┐
│                     统计模块                             │
├─────────┬─────────┬─────────┬─────────┬─────────────────┤
│ 数据    │ 生成    │ 可视化  │ 导出    │ 实时更新         │
│ 收集    │ 报表    │ 图表    │ 数据    │                 │
└─────────┴─────────┴─────────┴─────────┴─────────────────┘
```

## 3. 详细功能设计

### 3.1 问卷管理

#### 3.1.1 问卷创建
- **功能描述**：支持创建新问卷，设置标题、描述和截止时间
- **实现要点**：
  - 表单验证：标题必填，截止时间格式验证
  - 状态初始化为草稿
  - 返回问卷ID用于后续操作

#### 3.1.2 问题管理
- **功能描述**：支持添加、编辑、删除问题
- **实现要点**：
  - 支持拖拽排序
  - 实时保存到数据库
  - 删除问题时级联删除相关答案

#### 3.1.3 问题类型
- **功能描述**：支持打分题（1-5分制），可扩展至选择题、填空题等
- **实现要点**：
  - 使用枚举类型定义问题类型
  - 组件化设计，支持不同题型的动态渲染

#### 3.1.4 分数权重
- **功能描述**：每道题目可设置独立的分数权重
- **实现要点**：
  - 权重范围：0.1-5.0
  - 默认权重：1.0
  - 统计时按权重计算总分

#### 3.1.5 图片上传
- **功能描述**：支持在问题中上传和显示图片
- **实现要点**：
  - 支持JPG、PNG、GIF格式
  - 图片大小限制：5MB
  - 上传前预览
  - 支持CDN加速

#### 3.1.6 问卷预览
- **功能描述**：支持实时预览问卷效果
- **实现要点**：
  - 分屏预览或新窗口预览
  - 模拟填写体验

#### 3.1.7 问卷复制
- **功能描述**：支持复制现有问卷
- **实现要点**：
  - 复制问卷基本信息和问题
  - 新问卷状态为草稿
  - 生成新的问卷ID

#### 3.1.8 问卷状态管理
- **功能描述**：支持发布、暂停、关闭问卷
- **实现要点**：
  - 状态枚举：草稿、发布、暂停、关闭
  - 状态转换验证
  - 发布后生成二维码

### 3.2 问卷分发

#### 3.2.1 二维码生成
- **功能描述**：为每个问卷生成唯一二维码
- **实现要点**：
  - 使用QRCode.js库生成
  - 二维码包含问卷唯一访问链接
  - 支持自定义样式

#### 3.2.2 微信扫码
- **功能描述**：支持微信扫码直接填写问卷
- **实现要点**：
  - 适配微信浏览器
  - 支持微信内直接打开
  - 优化移动端体验

#### 3.2.3 链接分享
- **功能描述**：生成可分享的问卷链接
- **实现要点**：
  - 短链接生成（可选）
  - 支持复制到剪贴板
  - 链接包含问卷唯一标识

### 3.3 问卷填写

#### 3.3.1 微信适配
- **功能描述**：适配微信浏览器环境
- **实现要点**：
  - 响应式设计
  - 适配微信浏览器样式
  - 支持微信开发者工具调试

#### 3.3.2 匿名填写
- **功能描述**：支持匿名填写，自动生成用户标识
- **实现要点**：
  - 使用UUID生成唯一标识
  - 标识存储在浏览器Cookie中
  - 防止重复提交

#### 3.3.3 提交反馈
- **功能描述**：提交后显示感谢页面
- **实现要点**：
  - 提交成功提示
  - 可自定义感谢信息
  - 支持返回首页

### 3.4 数据统计

#### 3.4.1 实时统计
- **功能描述**：支持实时查看问卷填写进度
- **实现要点**：
  - 显示填写人数
  - 显示完成率
  - 支持实时更新

#### 3.4.2 柱状图展示
- **功能描述**：生成各问题的平均得分柱状图
- **实现要点**：
  - 使用Chart.js库
  - 按问题分组展示
  - 显示平均分和权重分

#### 3.4.3 权重计算
- **功能描述**：根据权重计算综合得分
- **实现要点**：
  - 计算每道题的加权得分
  - 计算总分和平均分
  - 支持导出统计数据

## 4. 数据库设计

### 4.1 核心数据模型

#### 4.1.1 问卷表（surveys）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | String | 问卷唯一标识（UUID） |
| title | String | 问卷标题 |
| description | String | 问卷描述 |
| creator_id | String | 创建者ID |
| status | Enum | 问卷状态（草稿、发布、暂停、关闭） |
| created_at | Timestamp | 创建时间 |
| updated_at | Timestamp | 更新时间 |
| expires_at | Timestamp | 截止时间 |

#### 4.1.2 问题表（questions）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | String | 问题唯一标识（UUID） |
| survey_id | String | 所属问卷ID |
| content | String | 问题内容 |
| type | Enum | 问题类型（打分题） |
| weight | Float | 分数权重 |
| image_url | String | 问题图片URL |
| order | Integer | 问题排序 |
| created_at | Timestamp | 创建时间 |

#### 4.1.3 回答表（responses）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | String | 回答唯一标识（UUID） |
| survey_id | String | 问卷ID |
| user_id | String | 用户标识（匿名生成） |
| question_id | String | 问题ID |
| score | Integer | 打分数值（1-5） |
| submitted_at | Timestamp | 提交时间 |

#### 4.1.4 用户表（users）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | String | 用户唯一标识（UUID） |
| openid | String | 微信OpenID |
| nickname | String | 微信昵称 |
| avatar | String | 微信头像 |
| created_at | Timestamp | 创建时间 |

### 4.2 关系图
```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   users     │       │   surveys   │       │ questions   │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id          │──────>│ creator_id  │──────>│ survey_id   │
│ openid      │       │ title       │       │ content     │
│ nickname    │       │ description │       │ type        │
│ avatar      │       │ status      │       │ weight      │
│ created_at  │       │ created_at  │       │ image_url   │
└─────────────┘       └─────────────┘       │ order       │
                                            │ created_at  │
                                            └─────────────┘
                                                    │
                                                    │
                                            ┌─────────────┐
                                            │ responses   │
                                            ├─────────────┤
                                            │ survey_id   │
                                            │ user_id     │
                                            │ question_id │<──┘
                                            │ score       │
                                            │ submitted_at│
                                            └─────────────┘
```

## 5. API设计

### 5.1 用户认证API

#### 5.1.1 微信登录
- **URL**：`/api/auth/wechat`
- **方法**：`POST`
- **参数**：
  - `code`：微信授权码
- **返回**：
  - `token`：JWT令牌
  - `user`：用户信息

#### 5.1.2 获取当前用户
- **URL**：`/api/auth/me`
- **方法**：`GET`
- **认证**：JWT
- **返回**：
  - `user`：当前用户信息

### 5.2 问卷管理API

#### 5.2.1 创建问卷
- **URL**：`/api/surveys`
- **方法**：`POST`
- **认证**：JWT
- **参数**：
  - `title`：问卷标题
  - `description`：问卷描述
  - `expires_at`：截止时间
- **返回**：
  - `survey`：创建的问卷信息

#### 5.2.2 获取问卷列表
- **URL**：`/api/surveys`
- **方法**：`GET`
- **认证**：JWT
- **参数**：
  - `page`：页码
  - `limit`：每页数量
  - `status`：状态过滤
- **返回**：
  - `surveys`：问卷列表
  - `total`：总数量

#### 5.2.3 获取问卷详情
- **URL**：`/api/surveys/:id`
- **方法**：`GET`
- **认证**：JWT（创建者）/ 匿名（填写者）
- **返回**：
  - `survey`：问卷详情
  - `questions`：问题列表

#### 5.2.4 更新问卷
- **URL**：`/api/surveys/:id`
- **方法**：`PUT`
- **认证**：JWT
- **参数**：
  - `title`：问卷标题
  - `description`：问卷描述
  - `status`：问卷状态
  - `expires_at`：截止时间
- **返回**：
  - `survey`：更新后的问卷信息

#### 5.2.5 删除问卷
- **URL**：`/api/surveys/:id`
- **方法**：`DELETE`
- **认证**：JWT
- **返回**：
  - `success`：删除结果

#### 5.2.6 复制问卷
- **URL**：`/api/surveys/:id/copy`
- **方法**：`POST`
- **认证**：JWT
- **返回**：
  - `survey`：复制的问卷信息

### 5.3 问题管理API

#### 5.3.1 添加问题
- **URL**：`/api/surveys/:surveyId/questions`
- **方法**：`POST`
- **认证**：JWT
- **参数**：
  - `content`：问题内容
  - `type`：问题类型
  - `weight`：分数权重
  - `image_url`：图片URL
  - `order`：问题排序
- **返回**：
  - `question`：创建的问题信息

#### 5.3.2 更新问题
- **URL**：`/api/questions/:id`
- **方法**：`PUT`
- **认证**：JWT
- **参数**：
  - `content`：问题内容
  - `type`：问题类型
  - `weight`：分数权重
  - `image_url`：图片URL
  - `order`：问题排序
- **返回**：
  - `question`：更新后的问题信息

#### 5.3.3 删除问题
- **URL**：`/api/questions/:id`
- **方法**：`DELETE`
- **认证**：JWT
- **返回**：
  - `success`：删除结果

### 5.4 图片上传API

#### 5.4.1 上传图片
- **URL**：`/api/upload/image`
- **方法**：`POST`
- **认证**：JWT
- **参数**：
  - `image`：图片文件（multipart/form-data）
- **返回**：
  - `url`：图片URL

### 5.5 问卷填写API

#### 5.5.1 提交问卷
- **URL**：`/api/surveys/:surveyId/submit`
- **方法**：`POST`
- **参数**：
  - `responses`：回答列表
    - `question_id`：问题ID
    - `score`：分数
  - `user_id`：用户标识（匿名）
- **返回**：
  - `success`：提交结果

### 5.6 统计API

#### 5.6.1 获取统计数据
- **URL**：`/api/surveys/:surveyId/statistics`
- **方法**：`GET`
- **认证**：JWT
- **返回**：
  - `total_responses`：总回答数
  - `average_score`：平均得分
  - `question_statistics`：问题统计列表
    - `question_id`：问题ID
    - `content`：问题内容
    - `average_score`：平均得分
    - `weighted_score`：加权得分
    - `distribution`：分数分布

## 6. 前端页面设计

### 6.1 页面结构

#### 6.1.1 管理端页面
- **登录页**：微信登录入口
- **问卷列表页**：展示用户创建的问卷
- **问卷创建页**：创建和编辑问卷
- **问题编辑页**：添加和编辑问题
- **问卷预览页**：预览问卷效果
- **统计分析页**：查看问卷统计数据
- **问卷设置页**：设置问卷状态和其他参数

#### 6.1.2 填写端页面
- **问卷填写页**：微信扫码填写问卷
- **感谢页**：提交成功后的感谢页面

### 6.2 核心页面设计

#### 6.2.1 问卷创建页
```
┌─────────────────────────────────────────────────────────┐
│ 顶部导航栏：标题输入、保存、预览、发布按钮             │
├─────────────────────────────────────────────────────────┤
│ 左侧：问卷基本信息设置（描述、截止时间）               │
├─────────────────────────────────────────────────────────┤
│ 右侧：问题列表，支持添加、编辑、删除、排序             │
│ 每个问题包含：内容、类型、权重、图片上传、删除按钮     │
└─────────────────────────────────────────────────────────┘
```

#### 6.2.2 问卷填写页
```
┌─────────────────────────────────────────────────────────┐
│ 问卷标题和描述                                         │
├─────────────────────────────────────────────────────────┤
│ 问题列表：                                             │
│ 1. 问题内容 + 图片（如果有）                           │
│    打分选项（1-5分）                                   │
│ 2. 下一个问题...                                       │
├─────────────────────────────────────────────────────────┤
│ 底部：提交按钮                                         │
└─────────────────────────────────────────────────────────┘
```

#### 6.2.3 统计分析页
```
┌─────────────────────────────────────────────────────────┐
│ 顶部：问卷标题、总回答数、平均得分                     │
├─────────────────────────────────────────────────────────┤
│ 中间：柱状图展示每个问题的平均得分                     │
├─────────────────────────────────────────────────────────┤
│ 底部：问题详情列表，包含每个问题的：                   │
│ - 问题内容                                             │
│ - 平均得分                                             │
│ - 加权得分                                             │
│ - 分数分布                                             │
└─────────────────────────────────────────────────────────┘
```

## 7. 实现计划

### 7.1 阶段一：基础架构搭建（2周）
- 初始化Next.js项目
- 配置Prisma和数据库
- 实现用户认证
- 搭建存储服务

### 7.2 阶段二：核心功能开发（3周）
- 问卷创建与管理
- 问题管理与图片上传
- 分数权重设置
- 问卷填写功能

### 7.3 阶段三：分发与统计（2周）
- 二维码生成
- 微信扫码适配
- 数据统计功能
- 柱状图可视化

### 7.4 阶段四：测试与优化（1周）
- 功能测试
- 性能优化
- 安全性测试
- 微信环境测试

### 7.5 阶段五：部署上线（1周）
- Vercel部署
- 腾讯云部署（可选）
- 上线前检查
- 正式发布

## 8. 测试计划

### 8.1 功能测试
- 问卷创建和编辑
- 问题管理
- 图片上传
- 问卷填写
- 数据统计

### 8.2 性能测试
- 页面加载时间
- 图片上传速度
- 统计数据计算时间
- 并发处理能力

### 8.3 安全性测试
- XSS攻击防护
- SQL注入防护
- 认证授权测试
- 数据加密测试

### 8.4 微信环境测试
- 微信浏览器兼容性
- 扫码功能测试
- 移动端适配测试
- 微信开发者工具测试

## 9. 部署计划

### 9.1 Vercel部署
- **步骤**：
  1. 连接GitHub仓库
  2. 配置环境变量
  3. 自动部署
  4. 配置域名

### 9.2 腾讯云部署
- **步骤**：
  1. 配置云函数
  2. 配置对象存储
  3. 配置数据库
  4. 部署前端应用
  5. 配置CDN

## 10. 风险评估与应对

| 风险点 | 可能性 | 影响程度 | 应对措施 |
|--------|--------|----------|----------|
| 微信浏览器兼容性问题 | 中 | 高 | 提前进行微信环境测试，使用微信开发者工具 |
| 图片上传性能问题 | 中 | 中 | 使用CDN加速，优化图片压缩算法 |
| 统计数据量大时性能问题 | 低 | 高 | 实现预计算和增量更新，优化查询语句 |
| 部署环境限制 | 中 | 中 | 选择灵活的技术栈，支持多种部署方式 |
| 恶意提交风险 | 中 | 中 | 实现防刷机制，IP限制，验证码等 |

## 11. 后续扩展计划

1. 支持更多题型（选择题、填空题等）
2. 添加问卷模板库
3. 支持多语言
4. 实现高级统计分析功能
5. 支持导出PDF/Excel报告
6. 开发微信小程序版本
7. 支持第三方系统集成
8. 添加AI智能分析功能

# 总结

本开发设计方案基于Next.js全栈框架，适合Serverless部署，特别是Vercel平台。采用前后端分离的设计思想，同时兼顾微信环境兼容性。数据库选择PostgreSQL，适合复杂的统计查询。存储服务使用Cloudinary或腾讯云COS，确保图片上传和访问性能。

系统架构具有良好的可扩展性，支持后续功能扩展和多平台部署。通过合理的性能优化和安全设计，确保系统在高并发情况下仍能稳定运行。

该设计充分考虑了用户需求和部署环境，是一个完整、可行的技术方案，为后续开发提供了清晰的指导。