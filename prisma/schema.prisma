// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  password  String?
  openid    String?  @unique
  nickname  String?
  avatar    String?
  surveys   Survey[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Survey {
  id          String     @id @default(cuid())
  title       String
  description String?
  creatorId   String     @map("creator_id")
  creator     User       @relation(fields: [creatorId], references: [id])
  status      String     @default("DRAFT") // DRAFT, PUBLISHED, PAUSED, CLOSED
  questions   Question[]
  responses   Response[]
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  expiresAt   DateTime?  @map("expires_at")
  isAnonymous Boolean   @default(false)
  isPublic    Boolean   @default(true)
  maxResponses Int?      @map("max_responses")

  @@map("surveys")
}

model Question {
  id        String   @id @default(cuid())
  surveyId  String   @map("survey_id")
  survey    Survey   @relation(fields: [surveyId], references: [id])
  parentId  String?  @map("parent_id")  // 父级问题ID，用于层级结构
  parent    Question? @relation("QuestionHierarchy", fields: [parentId], references: [id])
  children  Question[] @relation("QuestionHierarchy")
  content   String
  type      String   @default("RATING") // RATING, SINGLE_CHOICE, MULTIPLE_CHOICE, TEXT, GROUP, PROJECT, DIMENSION
  imageUrl  String?  @map("image_url")
  order     Int      @default(0)
  weight    Float    @default(1.0)     // 维度权重，用于权重计算
  options   QuestionOption[]
  responses Response[]
  createdAt DateTime @default(now()) @map("created_at")

  @@map("questions")
}

model QuestionOption {
  id         String   @id @default(cuid())
  questionId String   @map("question_id")
  question   Question @relation(fields: [questionId], references: [id])
  content    String
  score      Float    @default(0.0)  // 选项对应的分值
  weight     Float    @default(1.0)  // 选项权重
  order      Int      @default(0)
  responses  Response[]
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("question_options")
}

model Response {
  id         String   @id @default(cuid())
  surveyId   String   @map("survey_id")
  survey     Survey   @relation(fields: [surveyId], references: [id])
  userId     String   @map("user_id")
  questionId String   @map("question_id")
  question   Question @relation(fields: [questionId], references: [id])
  score      Int?     // 1-5 for rating questions
  optionId   String?  @map("option_id")
  option     QuestionOption? @relation(fields: [optionId], references: [id])
  textAnswer String?  @map("text_answer")
  submittedAt DateTime @default(now()) @map("submitted_at")

  @@unique([surveyId, userId, questionId])
  @@map("responses")
}